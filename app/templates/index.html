<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Social Earth Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <script src="static/js/jquery-3.3.1.min.js"></script>
    <script src="static/js/leaflet_sprite.js"></script>
    <script
       src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js">
    </script>



	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		#map {
			width: 100%;
			height: 600px;
		}
        * {
            box-sizing: border-box;
        }

        /* Create two equal columns that floats next to each other */
        .column {
            float: left;
            width: 50%;
            padding: 20px;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }
	</style>
</head>
<body>

    <h1>SocialDisaster: Earthquake Damage Assessment</h1>

    <div class="column">
    <div id="map"></div>

<script>
//TODO: make this a function and abstract it from the view.

var data = $.ajax({
  //url: "static/js/data/usgsEarthquacks_7days.json",
  //url: "static/js/data/earthquakes_world_2018_mag>=5_count=337.json",
  //url: "static/js/data/earthquakes_conterminousUS_2008-2018_mag>=4_count=1147.json",
  //url: "static/js/data/Tweets_earthquakes_conterminousUS_2008-2018_mag>=4_count=1147.json",
  url: "static/js/data/Evaluated_Tweets_earthquakes_world_2018_mag>=5_count=337.json",
  dataType:'json',
  type: 'GET',
}).done(function(data){
    var earthquakes = new L.FeatureGroup();
    //var dataParse = data.features;
    var dataParse = data;
    var quakePoints = [];
    var markerColor = "green";

    for (i=0; i< dataParse.length; i++){
        console.log(dataParse[i]); //View the data


        if(dataParse[i].magnitude < 5){
            markerColor = "green";
        }else if(dataParse[i].magnitude >= 5 & dataParse[i].magnitude < 6){
            markerColor = "blue";
        } else if(dataParse[i].magnitude >= 6 && dataParse[i].magnitude < 7){
            markerColor = "yellow";
        }else if(dataParse[i].magnitude >= 7 && dataParse[i].magnitude < 8){
            markerColor = "orange";
        }else if(dataParse[i].magnitude >= 8){
            markerColor = "red";
        }

        marker = L.marker(
            new L.LatLng(
                dataParse[i].coordinates[1],
                dataParse[i].coordinates[0]
            ),
            {icon: L.spriteIcon(markerColor)}
        ).bindPopup(
            "<strong>Date:</strong> "+toDateTime(dataParse[i].occurence_timestamp/1000)+" <br />"+
            "<strong>Location:</strong> "+dataParse[i].actual_city+" <br />"+
            "<strong>Magnitude</strong> "+dataParse[i].magnitude+" <br />"+
            "<strong>Depth:</strong> "+dataParse[i].coordinates[2]+"km <br />"+
            "<strong>Number of tweets:</strong> "+dataParse[i].tweets.length+" <br />"+
            "<strong>Damage assessment:</strong> <button onclick='dmgAssess(\"" + dataParse[i].id + "\")'>Compute</button>"
        );

        //See: https://earthquake.usgs.gov/earthquakes/feed/v1.0/geojson.php for data dictionary.
        earthquakes.addLayer(marker);

        /*
        quakePoints.push([dataParse[i].geometry.coordinates[1],
                dataParse[i].geometry.coordinates[0], dataParse[i].properties.mag]);//*/
        quakePoints.push([dataParse[i].coordinates[1], dataParse[i].coordinates[0], dataParse[i].magnitude]);//*/

    }

    var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

    var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
        streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});

    var map = L.map('map', {
        center: [39.73, -104.99],
        zoom: 3,
        layers: [grayscale, earthquakes]
    });

    var baseLayers = {
        "Grayscale": grayscale,
        "Streets": streets
    };

    var overlays = {
        "Earthquakes": earthquakes
    };

    L.control.layers(baseLayers, overlays).addTo(map);

    var heat = L.heatLayer(quakePoints,{
        radius: 20,
        blur: 15,
        maxZoom: 10
    }).addTo(map);
});

function dmgAssess(earthquake_id) {
    var canvas = document.getElementById("dmgAssessmentCanvas");
    var ctx=canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font="9px Comic Sans MS";
    ctx.fillStyle = "red";
    ctx.textAlign = "center";
    var line_h = 15;
    var x = canvas.width/2;
    var y = 10;
    //ctx.fillText("Hello World " + earthquake_id + " " + data + " " + dataParse, canvas.width/2, canvas.height/2);
    var earthquake_data = data.responseJSON
    var was_found = false;
    for (i=0; i< earthquake_data.length; i++){
        if(earthquake_data[i].id === earthquake_id){

            var tweets = earthquake_data[i].tweets;
            var tweets_str = " Earthquake magnitude : " + earthquake_data[i].magnitude + ", predicted magnitude (avg): " + earthquake_data[i].predicted_magnitude_average + " ." ;
            ctx.fillText(tweets_str, x, y );
            for(j = 0 ; j < tweets.length ; j++){
                tweets_str = 'Tweet id ' + tweets[j].id + ', predicted score: ' + tweets[j].predicted_magnitude  ;
                ctx.fillText(tweets_str, x, y + line_h * (j + 1));
            }


            was_found = true;
        }
    }
    if(!was_found){
        ctx.fillText("Hello World " + earthquake_id + " " + earthquake_data + " " + earthquake_data.length, canvas.width/2, canvas.height/2);
    }
}

function toDateTime(secs) {
    var t = new Date(1970, 0, 1); // Epoch
    t.setSeconds(secs);
    return t;
}
</script>

<h2>Search Earthquakes (Under development)</h2>

<form action="compute">
Month: <input type="text" name="Month" value="1">
Year: <input type="text" name="Year" value="2018">
<input type="submit" value="Search">
</form>

</div>

<div class="column">

<canvas id="dmgAssessmentCanvas" width="500" height="500"
style="border:1px solid #d3d3d3;">
Your browser does not support the canvas element.
</canvas>


<p id="demo"></p>

</div>



</body>
</html>
